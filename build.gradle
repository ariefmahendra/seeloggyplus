plugins {
    id 'java'
    id 'application'
    id 'org.openjfx.javafxplugin' version '0.1.0'
    id 'org.beryx.runtime' version '1.13.1'
}

group = 'com.seeloggyplus'
version = '1.0.0'

java {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
}

repositories {
    mavenCentral()
}

javafx {
    version = '21'
    modules = ['javafx.controls', 'javafx.fxml', 'javafx.web']
}

dependencies {
    // SECURITY UPDATE: Mengganti JSch lama dengan fork modern (Mwiede)
    // JSch lama (0.1.55) sering diflag oleh EPP sebagai tool hacking.
    implementation 'com.github.mwiede:jsch:0.2.16'

    // Lombok
    compileOnly 'org.projectlombok:lombok:1.18.34'
    annotationProcessor 'org.projectlombok:lombok:1.18.34'
    testCompileOnly 'org.projectlombok:lombok:1.18.34'
    testAnnotationProcessor 'org.projectlombok:lombok:1.18.34'

    // JSON
    implementation 'com.google.code.gson:gson:2.10.1'
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.15.2'

    // Caching
    implementation("com.github.ben-manes.caffeine:caffeine:3.2.2")

    // Database
    implementation 'org.xerial:sqlite-jdbc:3.44.1.0'

    // XML & Logging
    implementation 'org.dom4j:dom4j:2.2.0'
    implementation 'org.slf4j:slf4j-api:2.0.9'
    implementation 'ch.qos.logback:logback-classic:1.5.19'

    // Utilities
    implementation 'commons-io:commons-io:2.14.0'
    implementation 'org.apache.commons:commons-lang3:3.18.0'

    // UI Components
    implementation 'org.controlsfx:controlsfx:11.1.2'
    implementation 'org.fxmisc.richtext:richtextfx:0.11.2'
    implementation 'de.jensd:fontawesomefx-fontawesome:4.7.0-9.1.2'

    // LDAP
    implementation 'com.unboundid:unboundid-ldapsdk:7.0.3'

    // Testing
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.10.0'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.10.0'
}

application {
    mainClass = 'com.seeloggyplus.Main'
    applicationName = 'SeeloggyPlus'
}

tasks.named('test') {
    useJUnitPlatform()
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
}

// --- KONFIGURASI RUNTIME (JPACKAGE) ---
runtime {
    options = ['--strip-debug', '--compress', '2', '--no-header-files', '--no-man-pages']
    modules = [
            'java.desktop', 'java.logging', 'java.naming', 'java.sql', 'java.xml',
            'jdk.unsupported', 'java.scripting', 'javafx.controls', 'javafx.fxml',
            'javafx.web', 'javafx.graphics', 'jdk.crypto.ec', 'jdk.crypto.cryptoki',
            'java.management'
    ]

    launcher {
        noConsole = true
        jvmArgs = [
                '--add-opens', 'javafx.graphics/javafx.scene=ALL-UNNAMED',
                '--add-opens', 'javafx.controls/javafx.scene.control=ALL-UNNAMED',
                '--add-opens', 'javafx.controls/javafx.scene.control.skin=ALL-UNNAMED',
                '--add-opens', 'javafx.base/com.sun.javafx.runtime=ALL-UNNAMED'
        ]
    }

    jpackage {
        def currentVersion = project.version.toString()
        appVersion = currentVersion

        // FIX: Masukkan metadata ke imageOptions
        imageOptions = [
                '--icon', 'installer/icon.ico',
                '--vendor', 'Seeloggy Plus Solution',
                '--copyright', 'Copyright (c) 2025 SeeloggyPlus',
                '--description', 'Enterprise Logistics Management System'
        ]

        skipInstaller = true
    }

    targetPlatform('win') {
        jdkHome = jdkDownload('https://cdn.azul.com/zulu/bin/zulu17.46.19-ca-fx-jdk17.0.9-win_x64.zip')
    }
}

// --- TASK KHUSUS: STEALTH LAUNCHER ---

// 1. Task untuk membuat VBScript Launcher
// VBScript ini akan menjalankan java.exe (yang Signed/Terpercaya) secara langsung
// tanpa memicu peringatan "Unknown Publisher" dari .exe hasil compile.
tasks.register('createStealthLauncher') {
    group = 'distribution'
    description = 'Creates VBS launcher and REMOVES the unsigned EXE generated by jpackage'

    // Task ini berjalan setelah jpackage selesai membuat folder image
    dependsOn 'jpackageImage'

    doLast {
        // Sesuaikan nama folder dengan nama aplikasi Anda
        def jpackageDir = file("${buildDir}/jpackage/SeeloggyPlus")

        if (!jpackageDir.exists()) {
            println "Directory not found: ${jpackageDir}"
            return
        }

        // 1. BUAT VBS SCRIPT (Robust Version)
        // Script ini menggunakan path relatif terhadap lokasi script itu sendiri
        // Jadi aman dipindahkan kemana saja.
        def vbsFile = file("${jpackageDir}/Start_SeeloggyPlus.vbs")
        def vbsContent = """
Set WshShell = CreateObject("WScript.Shell")
Set fso = CreateObject("Scripting.FileSystemObject")
' Dapatkan folder dimana script ini berada
strDir = fso.GetParentFolderName(WScript.ScriptFullName)

' Jalankan java.exe dari folder runtime/bin/java.exe
' Menggunakan path absolut yang dibangun dari strDir untuk menghindari error path
cmd = chr(34) & strDir & "\\runtime\\bin\\java.exe" & chr(34) & " --add-opens javafx.graphics/javafx.scene=ALL-UNNAMED --add-opens javafx.controls/javafx.scene.control=ALL-UNNAMED --add-opens javafx.controls/javafx.scene.control.skin=ALL-UNNAMED --add-opens javafx.base/com.sun.javafx.runtime=ALL-UNNAMED -m com.seeloggyplus/com.seeloggyplus.Main"

' Run hidden (0)
WshShell.Run cmd, 0
Set WshShell = Nothing
Set fso = Nothing
        """
        vbsFile.text = vbsContent.trim()
        println "‚úÖ Stealth VBS launcher created."

        // 2. HAPUS FILE EXE BAWAAN (PENTING!)
        // Kita cari file .exe yang namanya sama dengan aplikasi
        def exeFile = file("${jpackageDir}/SeeloggyPlus.exe")
        if (exeFile.exists()) {
            exeFile.delete()
            println "üóëÔ∏è  REMOVED unsigned EXE file to avoid Endpoint Protection trigger: ${exeFile.name}"
        } else {
            println "‚ö†Ô∏è Warning: EXE file not found, maybe name mismatch?"
        }

        // Opsional: Hapus file .ico jika ada di root (agar lebih bersih)
        def icoFile = file("${jpackageDir}/SeeloggyPlus.ico")
        if (icoFile.exists()) icoFile.delete()
    }
}

tasks.register('createSafeZip', Zip) {
    group = 'distribution'
    description = 'Creates a generic ZIP distribution safe for EPP (No EXEs)'

    // Pastikan task cleanup di atas dijalankan dulu
    dependsOn 'createStealthLauncher'

    archiveFileName = "${project.name}-${version}-portable.zip"
    destinationDirectory = file("${buildDir}/distributions")

    from "${buildDir}/jpackage/SeeloggyPlus"

    // Double protection: Pastikan tidak ada exe yang ikut masuk zip
    exclude "*.exe"
    exclude "*.ico"

    into "${project.name}"

    doLast {
        println "üì¶ Safe ZIP created at: ${destinationDirectory}/${archiveFileName}"
        println "üëâ Distributed using VBS launcher only (No unsigned EXE inside)."
    }
}